machine:
  node:
    version: 6.9.0
  environment:
    PROTOCOL: http
    HOST: localhost
    PORT: 3000
    API_PROTOCOL: https
    API_HOST: thrive-api-ci.herokuapp.com
    API_PORT: 443
    SHOPIFY_URL: https://thrive-global-store.myshopify.com
    SEGMENT: B4DNEDpxrGAY0eqEPVLUJrlTzDkF1WLG
    ROLLBAR: 4beb8546e6bd49079c194739433e1eca
    NEW_RELIC_LICENSE_KEY: asdf
    FACEBOOK_ID: 235633273523923
    ROLLBAR_ENV: test

dependencies:
  cache_directories:
    - ./node_modules/

test:
  pre:
    - npm run heroku-postbuild
  override:
    - case $CIRCLE_NODE_INDEX in 1) npm run lint ;; 2) npm run analyze ;; 3) npm test -- --runInBand ;; esac:
        parallel: true
    - if [ $CIRCLE_NODE_INDEX = 0 ] then npm run start:test fi:
        background: true
        parallel: true
    - if [ $CIRCLE_NODE_INDEX = 0 ] java -jar bin/selenium-server-standalone-3.0.1.jar fi:
        background: true
        parallel: true
    - if [ $CIRCLE_NODE_INDEX = 0 ] ./nightwatch/wait_for_server.sh fi:
        parallel: true
    - if [ $CIRCLE_NODE_INDEX = 0 ] npm run test:circle:features fi:
        parallel: true
    - if [ $CIRCLE_NODE_INDEX = 0 ] cat ./coverage/lcov.info | ./node_modules/.bin/codacy-coverage fi:
        parallel: true

experimental:
  notify:
    branches:
      only:
        - master
